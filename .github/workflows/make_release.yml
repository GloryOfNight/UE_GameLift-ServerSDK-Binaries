name: Make release

on:
  workflow_dispatch:
    inputs:
      gamelift:
        description: 'GameLift ZIPed sources'
        default: 'GameLift-Cpp-ServerSDK-5.0.4'
        required: true
        type: string
      tag:
        description: 'A version tag'
        default: '0.0'
        required: true
        type: string

jobs:
  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
       upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v2

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.tag }}
          release_name: GameLift ${{ inputs.tag }} Binaries
          body: |
            Autogenerated release 
          draft: false
          prerelease: false
          
  gamelift_build_linux_x64:
    name: Build and upload Linux (x64)
    needs: create_release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Download and unzip gamelift
      run: |
       sudo apt-get update
       sudo apt-get install -y unzip
       wget https://gamelift-server-sdk-release.s3.us-west-2.amazonaws.com/cpp/${{ inputs.gamelift }}.zip -O gamelift.zip
       unzip -q gamelift.zip
       echo "download and unzip gamelift finished, files:"
       ls

    - name: Install tools
      run: |
       sudo apt-get update
       sudo apt-get install -y cmake
       sudo apt-get install -y gcc
       sudo apt-get install -y g++
       
    - name: Download and build OpenSSL 1.1.1n
      run: |
        wget -c https://www.openssl.org/source/old/1.1.1/openssl-1.1.1n.tar.gz -O - | tar -xz
        echo "download and unzip openssl finished, files:"
        ls
        cd openssl-1.1.1n
        ./config no-shared
        make -j

    - name: Configure and build
      run: |
        export OPENSSL_ROOT_DIR=${{ github.workspace }}/openssl-1.1.1n
        echo $OPENSSL_ROOT_DIR
        cd ${{ inputs.gamelift }}
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_FOR_UNREAL=1 -DRUN_CLANG_FORMAT=0
        cmake --build build -j

    - name: Upload binary to release
      id: upload-release-binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}
          asset_path: ${{ inputs.gamelift }}/build/prefix/lib/libaws-cpp-sdk-gamelift-server.so
          asset_name: linux-x64-libaws-cpp-sdk-gamelift-server.so
          asset_content_type: application/executable

  gamelift_build_windows_x64:
    name: Build and upload Windows (x64)
    needs: create_release
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2

    - name: Install tools
      run: |
        choco install cmake
        choco install curl
        choco install 7zip
        
    - name: Download and unzip gamelift
      run: |
        curl -o gamelift.zip https://gamelift-server-sdk-release.s3.us-west-2.amazonaws.com/cpp/${{ inputs.gamelift }}.zip
        7z x gamelift.zip

    - name: Configure and build
      run: |
        cd ${{ inputs.gamelift }}
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_FOR_UNREAL=1 -DRUN_CLANG_FORMAT=0
        cmake --build build --config Release
        
    - name: Upload lib to release
      id: upload-release-lib
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}
          asset_path: ${{ inputs.gamelift }}/build/prefix/lib/aws-cpp-sdk-gamelift-server.lib
          asset_name: win-x64-libaws-cpp-sdk-gamelift-server.lib
          asset_content_type: application/executable

    - name: Upload dll to release
      id: upload-release-dll
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}
          asset_path: ${{ inputs.gamelift }}/build/prefix/bin/aws-cpp-sdk-gamelift-server.dll
          asset_name: win-x64-libaws-cpp-sdk-gamelift-server.dll
          asset_content_type: application/executable
        
      
       
